cmake_minimum_required(VERSION 3.20)
project(DarkAgesServer VERSION 0.1.0 LANGUAGES CXX)

# C++20 is required
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Build options
option(BUILD_TESTS "Build tests" ON)
option(ENABLE_ASAN "Enable AddressSanitizer" OFF)
option(ENABLE_PROFILING "Enable Perfetto profiling" OFF)

# Phase 6 External Integration Options
option(ENABLE_GNS "Enable GameNetworkingSockets" ON)
option(ENABLE_REDIS "Enable Redis integration" ON)
option(ENABLE_SCYLLA "Enable ScyllaDB integration" ON)
option(ENABLE_FLATBUFFERS "Enable FlatBuffers protocol" ON)
option(FETCH_DEPENDENCIES "Fetch external dependencies automatically" ON)

# Compiler warnings
if(MSVC)
    add_compile_options(/W4 /WX-)
    add_compile_options(/permissive-)
    add_compile_options(/Zc:__cplusplus)
    add_compile_options(/MP)  # Multi-processor compilation
else()
    add_compile_options(-Wall -Wextra -Wpedantic)
    add_compile_options(-Wno-unused-parameter -Wno-unused-variable)
    add_compile_options(-Wno-missing-field-initializers)
endif()

# AddressSanitizer for debug builds
if(ENABLE_ASAN AND NOT MSVC)
    add_compile_options(-fsanitize=address -fno-omit-frame-pointer)
    add_link_options(-fsanitize=address)
endif()

# Find required packages
find_package(Threads REQUIRED)

# ============================================================================
# Local Dependencies (EnTT, GLM)
# ============================================================================

# Check for EnTT
if(EXISTS "${CMAKE_SOURCE_DIR}/deps/entt/single_include/entt/entt.hpp")
    message(STATUS "EnTT found in deps/entt")
    set(ENTT_INCLUDE_DIR "${CMAKE_SOURCE_DIR}/deps/entt/single_include")
    set(ENTT_FOUND TRUE)
else()
    if(FETCH_DEPENDENCIES)
        message(STATUS "Fetching EnTT...")
        include(FetchContent)
        FetchContent_Declare(
            EnTT
            GIT_REPOSITORY https://github.com/skypjack/entt.git
            GIT_TAG v3.13.0
        )
        FetchContent_MakeAvailable(EnTT)
        set(ENTT_INCLUDE_DIR "${entt_SOURCE_DIR}/single_include")
        set(ENTT_FOUND TRUE)
    else()
        message(FATAL_ERROR "EnTT not found. Run: git clone --branch v3.13.0 https://github.com/skypjack/entt.git deps/entt")
    endif()
endif()

# Check for GLM
if(EXISTS "${CMAKE_SOURCE_DIR}/deps/glm/glm/glm.hpp")
    message(STATUS "GLM found in deps/glm")
    set(GLM_INCLUDE_DIR "${CMAKE_SOURCE_DIR}/deps/glm")
    set(GLM_FOUND TRUE)
else()
    if(FETCH_DEPENDENCIES)
        message(STATUS "Fetching GLM...")
        include(FetchContent)
        FetchContent_Declare(
            glm
            GIT_REPOSITORY https://github.com/g-truc/glm.git
            GIT_TAG 0.9.9.8
        )
        FetchContent_MakeAvailable(glm)
        set(GLM_INCLUDE_DIR "${glm_SOURCE_DIR}")
        set(GLM_FOUND TRUE)
    else()
        message(FATAL_ERROR "GLM not found. Run: git clone --branch 0.9.9.8 https://github.com/g-truc/glm.git deps/glm")
    endif()
endif()

# ============================================================================
# External Dependencies (Phase 6)
# ============================================================================

include(FetchContent)

# FlatBuffers (v24.3.25) - Protocol serialization
if(ENABLE_FLATBUFFERS)
    find_package(Flatbuffers QUIET)
    if(Flatbuffers_FOUND OR flatbuffers_FOUND)
        message(STATUS "FlatBuffers found via find_package")
        set(FLATBUFFERS_FOUND TRUE)
    else()
        if(FETCH_DEPENDENCIES)
            message(STATUS "Fetching FlatBuffers v24.3.25...")
            FetchContent_Declare(
                flatbuffers
                GIT_REPOSITORY https://github.com/google/flatbuffers.git
                GIT_TAG v24.3.25
                GIT_SHALLOW TRUE
            )
            
            # Build options
            set(FLATBUFFERS_BUILD_TESTS OFF CACHE BOOL "" FORCE)
            set(FLATBUFFERS_BUILD_FLATHASH OFF CACHE BOOL "" FORCE)
            set(FLATBUFFERS_BUILD_FLATLIB OFF CACHE BOOL "" FORCE)
            set(FLATBUFFERS_BUILD_FLATC ON CACHE BOOL "" FORCE)  # Need compiler
            
            FetchContent_MakeAvailable(flatbuffers)
            set(FLATBUFFERS_FOUND TRUE)
            set(FlatBuffers_LIBRARIES flatbuffers::flatbuffers)
            set(FLATBUFFERS_FLATC_EXECUTABLE $<TARGET_FILE:flatbuffers::flatc>)
        else()
            message(WARNING "FlatBuffers not found. Protocol serialization may fail.")
            set(FLATBUFFERS_FOUND FALSE)
        endif()
    endif()
else()
    message(STATUS "FlatBuffers: Disabled (ENABLE_FLATBUFFERS=OFF)")
    set(FLATBUFFERS_FOUND FALSE)
endif()

# GameNetworkingSockets (v1.4.1) - UDP networking
if(ENABLE_GNS)
    find_package(GameNetworkingSockets QUIET)
    if(GameNetworkingSockets_FOUND)
        message(STATUS "GameNetworkingSockets found via find_package")
        set(GNS_FOUND TRUE)
        set(GameNetworkingSockets_LIBRARIES GameNetworkingSockets::GameNetworkingSockets)
    else()
        if(FETCH_DEPENDENCIES)
            message(STATUS "Fetching GameNetworkingSockets v1.4.1...")
            
            # Check for OpenSSL (required by GNS)
            find_package(OpenSSL QUIET)
            if(NOT OpenSSL_FOUND AND MSVC)
                message(WARNING "OpenSSL not found. GNS may fail to build on Windows.")
                message(STATUS "Install OpenSSL: winget install ShiningLight.OpenSSL")
            endif()
            
            FetchContent_Declare(
                GameNetworkingSockets
                GIT_REPOSITORY https://github.com/ValveSoftware/GameNetworkingSockets.git
                GIT_TAG v1.4.1
                GIT_SHALLOW TRUE
            )
            
            # GNS build options
            set(BUILD_EXAMPLES OFF CACHE BOOL "" FORCE)
            set(BUILD_TESTS OFF CACHE BOOL "" FORCE)
            set(BUILD_STATIC_LIB ON CACHE BOOL "" FORCE)
            set(BUILD_SHARED_LIB OFF CACHE BOOL "" FORCE)
            set(BUILD_TOOLS OFF CACHE BOOL "" FORCE)
            set(STEAMWEBRTC OFF CACHE BOOL "" FORCE)
            set(USE_CRYPTO MBEDTLS CACHE STRING "" FORCE)
            
            FetchContent_MakeAvailable(GameNetworkingSockets)
            set(GNS_FOUND TRUE)
            set(GameNetworkingSockets_LIBRARIES GameNetworkingSockets::GameNetworkingSockets)
        else()
            message(WARNING "GameNetworkingSockets not found. Using stub implementation.")
            set(GNS_FOUND FALSE)
        endif()
    endif()
else()
    message(STATUS "GameNetworkingSockets: Disabled (ENABLE_GNS=OFF)")
    set(GNS_FOUND FALSE)
endif()

# hiredis (v1.2.0) - Redis client
if(ENABLE_REDIS)
    find_package(hiredis QUIET)
    if(hiredis_FOUND)
        message(STATUS "hiredis found via find_package")
        set(HIREDIS_FOUND TRUE)
        set(hiredis_LIBRARIES hiredis::hiredis)
    else()
        if(FETCH_DEPENDENCIES)
            message(STATUS "Fetching hiredis v1.2.0...")
            FetchContent_Declare(
                hiredis
                GIT_REPOSITORY https://github.com/redis/hiredis.git
                GIT_TAG v1.2.0
                GIT_SHALLOW TRUE
            )
            
            # hiredis build options
            set(ENABLE_SSL OFF CACHE BOOL "" FORCE)
            set(BUILD_SHARED_LIBS OFF CACHE BOOL "" FORCE)
            
            FetchContent_MakeAvailable(hiredis)
            set(HIREDIS_FOUND TRUE)
            set(hiredis_LIBRARIES hiredis::hiredis)
        else()
            message(WARNING "hiredis not found. Using stub implementation.")
            set(HIREDIS_FOUND FALSE)
        endif()
    endif()
else()
    message(STATUS "hiredis: Disabled (ENABLE_REDIS=OFF)")
    set(HIREDIS_FOUND FALSE)
endif()

# cassandra-cpp-driver (2.17.1) - ScyllaDB/Cassandra client
if(ENABLE_SCYLLA)
    find_package(cassandra QUIET)
    if(cassandra_FOUND)
        message(STATUS "cassandra-cpp-driver found via find_package")
        set(CASSANDRA_FOUND TRUE)
        set(cassandra_LIBRARIES cassandra_static)
    else()
        if(FETCH_DEPENDENCIES)
            message(STATUS "Fetching cassandra-cpp-driver v2.17.1...")
            FetchContent_Declare(
                cassandra
                GIT_REPOSITORY https://github.com/datastax/cpp-driver.git
                GIT_TAG 2.17.1
                GIT_SHALLOW TRUE
            )
            
            # Cassandra driver build options
            set(CASS_BUILD_STATIC ON CACHE BOOL "" FORCE)
            set(CASS_BUILD_SHARED OFF CACHE BOOL "" FORCE)
            set(CASS_BUILD_EXAMPLES OFF CACHE BOOL "" FORCE)
            set(CASS_BUILD_TESTS OFF CACHE BOOL "" FORCE)
            set(CASS_BUILD_DOCS OFF CACHE BOOL "" FORCE)
            
            FetchContent_MakeAvailable(cassandra)
            set(CASSANDRA_FOUND TRUE)
            set(cassandra_LIBRARIES cassandra_static)
        else()
            message(WARNING "cassandra-cpp-driver not found. Using stub implementation.")
            set(CASSANDRA_FOUND FALSE)
        endif()
    endif()
else()
    message(STATUS "cassandra-cpp-driver: Disabled (ENABLE_SCYLLA=OFF)")
    set(CASSANDRA_FOUND FALSE)
endif()

# nlohmann/json (v3.11.3) - JSON serialization for Redis
FetchContent_Declare(
    json
    GIT_REPOSITORY https://github.com/nlohmann/json.git
    GIT_TAG v3.11.3
    GIT_SHALLOW TRUE
)

# nlohmann/json is header-only and always available
FetchContent_MakeAvailable(json)
set(NLOHMANN_JSON_FOUND TRUE)
message(STATUS "nlohmann/json v3.11.3 available")

# ============================================================================
# FlatBuffers Code Generation
# ============================================================================

if(FLATBUFFERS_FOUND AND EXISTS "${CMAKE_SOURCE_DIR}/src/shared/proto/game_protocol.fbs")
    set(FBS_SCHEMA ${CMAKE_SOURCE_DIR}/src/shared/proto/game_protocol.fbs)
    set(FBS_GENERATED_DIR ${CMAKE_BINARY_DIR}/generated)
    file(MAKE_DIRECTORY ${FBS_GENERATED_DIR})
    
    add_custom_command(
        OUTPUT 
            ${FBS_GENERATED_DIR}/game_protocol_generated.h
        COMMAND 
            ${FLATBUFFERS_FLATC_EXECUTABLE}
            --cpp
            --gen-object-api
            --gen-compare
            -o ${FBS_GENERATED_DIR}
            ${FBS_SCHEMA}
        DEPENDS ${FBS_SCHEMA} flatbuffers::flatc
        COMMENT "Generating FlatBuffers C++ code from ${FBS_SCHEMA}"
    )
    
    add_custom_target(fbs_generation ALL
        DEPENDS 
            ${FBS_GENERATED_DIR}/game_protocol_generated.h
    )
    
    set(FLATBUFFERS_GENERATED_DIR ${FBS_GENERATED_DIR})
    message(STATUS "FlatBuffers code generation configured")
endif()

# ============================================================================
# Core Library Source Files
# ============================================================================

set(SERVER_SOURCES
    src/server/src/ecs/CoreTypes.cpp
    src/server/src/physics/SpatialHash.cpp
    src/server/src/physics/MovementSystem.cpp
    src/server/src/memory/MemoryPool.cpp
    src/server/src/memory/LeakDetector.cpp
    src/server/src/combat/CombatSystem.cpp
    src/server/src/combat/PositionHistory.cpp
    src/server/src/combat/LagCompensatedCombat.cpp
    src/server/src/zones/AreaOfInterest.cpp
    src/server/src/zones/AuraProjection.cpp
    src/server/src/zones/ReplicationOptimizer.cpp
    src/server/src/zones/EntityMigration.cpp
    src/server/src/zones/ZoneHandoff.cpp
    src/server/src/zones/ZoneOrchestrator.cpp
    src/server/src/zones/ZoneServer.cpp
    src/server/src/zones/CrossZoneMessenger.cpp
    src/server/src/security/AntiCheat.cpp
    src/server/src/security/DDoSProtection.cpp
    src/server/src/profiling/PerformanceMonitor.cpp
)

# Network layer - conditional on GameNetworkingSockets
if(GNS_FOUND)
    list(APPEND SERVER_SOURCES src/server/src/netcode/NetworkManager.cpp)
    message(STATUS "NetworkManager: Using GameNetworkingSockets implementation")
else()
    list(APPEND SERVER_SOURCES src/server/src/netcode/NetworkManager_stub.cpp)
    message(WARNING "NetworkManager: Using stub implementation")
endif()

# Database layer - conditional on hiredis and cassandra-cpp-driver
if(HIREDIS_FOUND)
    list(APPEND SERVER_SOURCES src/server/src/db/RedisManager.cpp)
    message(STATUS "RedisManager: Using hiredis implementation")
else()
    list(APPEND SERVER_SOURCES src/server/src/db/RedisManager_stub.cpp)
    message(WARNING "RedisManager: Using stub implementation")
endif()

if(CASSANDRA_FOUND)
    list(APPEND SERVER_SOURCES src/server/src/db/ScyllaManager.cpp)
    message(STATUS "ScyllaManager: Using cassandra-cpp-driver implementation")
else()
    list(APPEND SERVER_SOURCES src/server/src/db/ScyllaManager_stub.cpp)
    message(WARNING "ScyllaManager: Using stub implementation")
endif()

# Profiling layer
if(ENABLE_PROFILING)
    list(APPEND SERVER_SOURCES src/server/src/profiling/PerfettoProfiler.cpp)
else()
    list(APPEND SERVER_SOURCES src/server/src/profiling/PerfettoProfiler_stub.cpp)
endif()

# ============================================================================
# darkages_core Library
# ============================================================================

add_library(darkages_core OBJECT ${SERVER_SOURCES})

# Core include directories
target_include_directories(darkages_core PUBLIC
    ${CMAKE_CURRENT_SOURCE_DIR}/src/server/include
    ${ENTT_INCLUDE_DIR}
    ${GLM_INCLUDE_DIR}
)

# External dependency includes
if(FLATBUFFERS_FOUND)
    target_include_directories(darkages_core PUBLIC 
        ${flatbuffers_SOURCE_DIR}/include
    )
    if(FLATBUFFERS_GENERATED_DIR)
        target_include_directories(darkages_core PUBLIC ${FLATBUFFERS_GENERATED_DIR})
        add_dependencies(darkages_core fbs_generation)
    endif()
endif()

if(GNS_FOUND)
    target_include_directories(darkages_core PUBLIC 
        ${GameNetworkingSockets_SOURCE_DIR}/include
    )
endif()

if(HIREDIS_FOUND)
    target_include_directories(darkages_core PUBLIC 
        ${hiredis_SOURCE_DIR}
        ${hiredis_SOURCE_DIR}/include
    )
endif()

if(CASSANDRA_FOUND)
    target_include_directories(darkages_core PUBLIC 
        ${cassandra_SOURCE_DIR}/include
    )
endif()

# nlohmann/json is always included (header-only)
target_include_directories(darkages_core PUBLIC 
    ${json_SOURCE_DIR}/single_include
)

# Core linking
target_link_libraries(darkages_core PUBLIC Threads::Threads)

# External library linking
if(FLATBUFFERS_FOUND AND FlatBuffers_LIBRARIES)
    target_link_libraries(darkages_core PUBLIC ${FlatBuffers_LIBRARIES})
    target_compile_definitions(darkages_core PUBLIC ENABLE_FLATBUFFERS=1)
endif()

if(GNS_FOUND AND GameNetworkingSockets_LIBRARIES)
    target_link_libraries(darkages_core PUBLIC ${GameNetworkingSockets_LIBRARIES})
    target_compile_definitions(darkages_core PUBLIC ENABLE_GNS=1)
    
    # Windows-specific libraries for GameNetworkingSockets
    if(WIN32)
        target_link_libraries(darkages_core PUBLIC 
            ws2_32
            winmm
            crypt32
            iphlpapi
        )
    endif()
endif()

if(HIREDIS_FOUND AND hiredis_LIBRARIES)
    target_link_libraries(darkages_core PUBLIC ${hiredis_LIBRARIES})
    target_compile_definitions(darkages_core PUBLIC ENABLE_REDIS=1)
endif()

if(CASSANDRA_FOUND AND cassandra_LIBRARIES)
    target_link_libraries(darkages_core PUBLIC ${cassandra_LIBRARIES})
    target_compile_definitions(darkages_core PUBLIC ENABLE_SCYLLA=1)
endif()

# nlohmann/json is header-only, no linking needed
target_compile_definitions(darkages_core PUBLIC ENABLE_NLOHMANN_JSON=1)

# ============================================================================
# darkages_server Executable
# ============================================================================

add_executable(darkages_server src/server/src/main.cpp)

target_link_libraries(darkages_server PRIVATE darkages_core)

# Windows subsystem settings
if(WIN32)
    set_target_properties(darkages_server PROPERTIES
        WIN32_EXECUTABLE FALSE
    )
endif()

# ============================================================================
# Testing
# ============================================================================

if(BUILD_TESTS)
    include(FetchContent)
    FetchContent_Declare(
        Catch2
        GIT_REPOSITORY https://github.com/catchorg/Catch2.git
        GIT_TAG v3.5.0
    )
    FetchContent_MakeAvailable(Catch2)
    
    set(TEST_SOURCES
        src/server/tests/TestSpatialHash.cpp
        src/server/tests/TestMovementSystem.cpp
        src/server/tests/TestMemoryPool.cpp
        src/server/tests/TestNetworkProtocol.cpp
        src/server/tests/TestAreaOfInterest.cpp
        src/server/tests/TestReplicationOptimizer.cpp
        src/server/tests/TestCombatSystem.cpp
        src/server/tests/TestLagCompensator.cpp
        src/server/tests/TestLagCompensatedCombat.cpp
        src/server/tests/TestAuraProjection.cpp
        src/server/tests/TestEntityMigration.cpp
        src/server/tests/TestZoneOrchestrator.cpp
        src/server/tests/TestDDoSProtection.cpp
        src/server/tests/TestProfiling.cpp
    )
    
    # Filter out tests that don't exist yet
    set(FINAL_TEST_SOURCES)
    foreach(test_file ${TEST_SOURCES})
        if(EXISTS "${CMAKE_SOURCE_DIR}/${test_file}")
            list(APPEND FINAL_TEST_SOURCES ${test_file})
        else()
            message(STATUS "Test file not found (skipping): ${test_file}")
        endif()
    endforeach()
    
    add_executable(darkages_tests ${FINAL_TEST_SOURCES})
    target_link_libraries(darkages_tests PRIVATE darkages_core Catch2::Catch2WithMain)
    target_compile_definitions(darkages_tests PRIVATE 
        TEST_DATA_DIR="${CMAKE_SOURCE_DIR}/test_data"
    )
    
    enable_testing()
    add_test(NAME unit_tests COMMAND darkages_tests --reporter console)
    
    # Individual test suites for CI/CD reporting
    add_test(NAME test_spatial COMMAND darkages_tests "[spatial]")
    add_test(NAME test_movement COMMAND darkages_tests "[movement]")
    add_test(NAME test_memory COMMAND darkages_tests "[memory]")
    add_test(NAME test_combat COMMAND darkages_tests "[combat]")
    add_test(NAME test_aoi COMMAND darkages_tests "[aoi]")
    add_test(NAME test_network COMMAND darkages_tests "[network]")
    add_test(NAME test_zones COMMAND darkages_tests "[zones]")
    add_test(NAME test_security COMMAND darkages_tests "[security]")
endif()

# ============================================================================
# Install Targets
# ============================================================================

install(TARGETS darkages_server
    RUNTIME DESTINATION bin
)

install(DIRECTORY src/server/include/
    DESTINATION include
    FILES_MATCHING PATTERN "*.hpp"
)

# ============================================================================
# Build Status Output
# ============================================================================

message("")
message("========================================")
message("DarkAges Server Build Configuration")
message("========================================")
message("C++ Standard: ${CMAKE_CXX_STANDARD}")
message("Build type: ${CMAKE_BUILD_TYPE}")
message("Build tests: ${BUILD_TESTS}")
message("AddressSanitizer: ${ENABLE_ASAN}")
message("")
message("Dependencies:")
message("  EnTT: ${ENTT_FOUND} - ${ENTT_INCLUDE_DIR}")
message("  GLM: ${GLM_FOUND} - ${GLM_INCLUDE_DIR}")
message("  FlatBuffers: ${FLATBUFFERS_FOUND}")
message("  GameNetworkingSockets: ${GNS_FOUND}")
message("  hiredis: ${HIREDIS_FOUND}")
message("  cassandra-cpp-driver: ${CASSANDRA_FOUND}")
message("  nlohmann/json: ${NLOHMANN_JSON_FOUND}")
message("========================================")
message("")
