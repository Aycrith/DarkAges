apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: scylla
  namespace: darkages
  labels:
    app: scylla
spec:
  serviceName: scylla
  replicas: 5
  selector:
    matchLabels:
      app: scylla
  template:
    metadata:
      labels:
        app: scylla
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - scylla
              topologyKey: kubernetes.io/hostname
      containers:
        - name: scylla
          image: scylladb/scylla:5.4
          args:
            - --smp
            - "2"
            - --memory
            - "4G"
            - --developer-mode
            - "0"
            - --seeds
            - "scylla-0.scylla.darkages.svc.cluster.local"
            - --listen-address
            - "$(POD_IP)"
            - --broadcast-address
            - "$(POD_IP)"
            - --broadcast-rpc-address
            - "$(POD_IP)"
            - --authenticator
            - "PasswordAuthenticator"
            - --authorizer
            - "CassandraAuthorizer"
          ports:
            - name: cql
              containerPort: 9042
            - name: thrift
              containerPort: 9160
            - name: intra-node
              containerPort: 7000
            - name: tls-intra-node
              containerPort: 7001
            - name: jmx
              containerPort: 7199
            - name: prometheus
              containerPort: 9180
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: SCYLLA_CLUSTER_NAME
              value: "darkages-cluster"
            - name: SCYLLA_DC
              value: "dc1"
            - name: SCYLLA_RACK
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: SCYLLA_AUTO_BOOTSTRAP
              value: "true"
          resources:
            requests:
              cpu: 2000m
              memory: 4Gi
            limits:
              cpu: 4000m
              memory: 8Gi
          volumeMounts:
            - name: data
              mountPath: /var/lib/scylla
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - cqlsh -u cassandra -p cassandra -e "SELECT now() FROM system.local"
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - cqlsh -u cassandra -p cassandra -e "SELECT now() FROM system.local"
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
          securityContext:
            capabilities:
              add:
                - IPC_LOCK
                - SYS_NICE
                - SYS_RESOURCE
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: fast-ssd
        resources:
          requests:
            storage: 100Gi
---
apiVersion: v1
kind: Service
metadata:
  name: scylla
  namespace: darkages
  labels:
    app: scylla
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: cql
      port: 9042
      targetPort: 9042
    - name: thrift
      port: 9160
      targetPort: 9160
    - name: intra-node
      port: 7000
      targetPort: 7000
    - name: tls-intra-node
      port: 7001
      targetPort: 7001
    - name: jmx
      port: 7199
      targetPort: 7199
    - name: prometheus
      port: 9180
      targetPort: 9180
  selector:
    app: scylla
---
# Scylla Manager for automated operations
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scylla-manager
  namespace: darkages
spec:
  replicas: 1
  selector:
    matchLabels:
      app: scylla-manager
  template:
    metadata:
      labels:
        app: scylla-manager
    spec:
      containers:
        - name: manager
          image: scylladb/scylla-manager:3.2
          command:
            - /usr/bin/scylla-manager
          args:
            - --config-file
            - /etc/scylla-manager/scylla-manager.yaml
          ports:
            - name: api
              containerPort: 56080
            - name: prometheus
              containerPort: 56090
          volumeMounts:
            - name: config
              mountPath: /etc/scylla-manager
            - name: data
              mountPath: /var/lib/scylla-manager
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
      volumes:
        - name: config
          configMap:
            name: scylla-manager-config
        - name: data
          persistentVolumeClaim:
            claimName: scylla-manager-data
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: scylla-manager-config
  namespace: darkages
data:
  scylla-manager.yaml: |
    http: :56080
    logger:
      level: info
    database:
      hosts:
        - scylla-0.scylla.darkages.svc.cluster.local
      keyspace: scylladb_manager
      replication_factor: 3
    ssl: false
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: scylla-manager-data
  namespace: darkages
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: standard
  resources:
    requests:
      storage: 10Gi
